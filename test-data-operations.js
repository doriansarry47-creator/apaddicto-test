#!/usr/bin/env node

import fetch from 'node-fetch';

const BASE_URL = 'https://5000-ij4n9x3ef6n5k5lmrkmbd-6532622b.e2b.dev';

// Fonction helper pour les requ√™tes avec gestion des cookies
async function makeRequest(url, options = {}, cookies = '') {
  const headers = {
    'Content-Type': 'application/json',
    ...options.headers
  };
  
  if (cookies) {
    headers['Cookie'] = cookies;
  }

  const response = await fetch(url, {
    ...options,
    headers
  });

  // Extraire les cookies de la r√©ponse
  const setCookieHeaders = response.headers.raw()['set-cookie'] || [];
  let newCookies = cookies;
  setCookieHeaders.forEach(cookie => {
    const [cookiePart] = cookie.split(';');
    const [name, value] = cookiePart.split('=');
    if (name && value) {
      newCookies = newCookies.replace(new RegExp(`${name}=[^;]*;?\\s*`), '');
      newCookies += `${name}=${value}; `;
    }
  });

  return { response, cookies: newCookies.trim() };
}

async function loginAsAdmin() {
  console.log('üîë Connexion en tant qu\'admin...');
  
  const { response, cookies } = await makeRequest(`${BASE_URL}/api/auth/login`, {
    method: 'POST',
    body: JSON.stringify({
      email: 'doriansarry@yahoo.fr',
      password: 'admin123'
    })
  });

  if (!response.ok) {
    console.error('‚ùå Impossible de se connecter en tant qu\'admin');
    return null;
  }

  const data = await response.json();
  console.log('‚úÖ Connexion admin r√©ussie:', data.user.role);
  return cookies;
}

async function loginAsPatient() {
  console.log('üîë Cr√©ation et connexion d\'un patient de test...');
  
  // Cr√©er un patient de test
  const patientData = {
    email: `patient_test_${Date.now()}@test.com`,
    password: 'password123',
    firstName: 'Marie',
    lastName: 'Patiente',
    role: 'patient'
  };

  // S'inscrire
  const registerResponse = await makeRequest(`${BASE_URL}/api/auth/register`, {
    method: 'POST',
    body: JSON.stringify(patientData)
  });

  if (!registerResponse.response.ok) {
    console.error('‚ùå Impossible de cr√©er le patient de test');
    return null;
  }

  // Se connecter
  const { response, cookies } = await makeRequest(`${BASE_URL}/api/auth/login`, {
    method: 'POST',
    body: JSON.stringify({
      email: patientData.email,
      password: patientData.password
    })
  });

  if (!response.ok) {
    console.error('‚ùå Impossible de se connecter en tant que patient');
    return null;
  }

  const data = await response.json();
  console.log('‚úÖ Connexion patient r√©ussie:', data.user.email);
  return { cookies, userId: data.user.id };
}

async function testExerciseOperations(adminCookies, patientInfo) {
  console.log('\nüìö Test: Op√©rations sur les exercices');

  // 1. Lister les exercices (public)
  console.log('1. R√©cup√©ration de la liste des exercices...');
  const { response: exercisesResponse } = await makeRequest(`${BASE_URL}/api/exercises`);
  
  if (exercisesResponse.ok) {
    const exercises = await exercisesResponse.json();
    console.log(`‚úÖ ${exercises.length} exercices r√©cup√©r√©s`);
  } else {
    console.error('‚ùå Erreur r√©cup√©ration exercices');
    return false;
  }

  // 2. Cr√©er un nouvel exercice (admin seulement)
  console.log('2. Cr√©ation d\'un nouvel exercice (admin)...');
  const newExercise = {
    title: `Exercice de test ${Date.now()}`,
    description: 'Description de test pour l\'exercice',
    type: 'therapeutic',
    category: 'relaxation', // Ajouter la cat√©gorie requise
    difficulty: 'beginner',
    duration: 15,
    instructions: 'Instructions de test'
  };

  const { response: createResponse } = await makeRequest(`${BASE_URL}/api/exercises`, {
    method: 'POST',
    body: JSON.stringify(newExercise)
  }, adminCookies);

  if (createResponse.ok) {
    const createdExercise = await createResponse.json();
    console.log('‚úÖ Exercice cr√©√© avec succ√®s:', createdExercise.id);
    return createdExercise.id;
  } else {
    console.error('‚ùå Erreur cr√©ation exercice:', await createResponse.text());
    return false;
  }
}

async function testCravingEntries(patientInfo) {
  console.log('\nüéØ Test: Enregistrement des envies');

  // Enregistrer une envie
  const cravingData = {
    intensity: 8,
    trigger: 'Test trigger',
    notes: 'Notes de test pour l\'envie'
  };

  console.log('1. Enregistrement d\'une envie...');
  const { response } = await makeRequest(`${BASE_URL}/api/cravings`, {
    method: 'POST',
    body: JSON.stringify(cravingData)
  }, patientInfo.cookies);

  if (response.ok) {
    const result = await response.json();
    console.log('‚úÖ Envie enregistr√©e avec succ√®s:', result.id);
    
    // R√©cup√©rer l'historique des envies
    console.log('2. R√©cup√©ration de l\'historique des envies...');
    const { response: historyResponse } = await makeRequest(`${BASE_URL}/api/cravings`, {}, patientInfo.cookies);
    
    if (historyResponse.ok) {
      const history = await historyResponse.json();
      console.log(`‚úÖ Historique r√©cup√©r√©: ${history.length} entr√©es`);
      return true;
    } else {
      console.error('‚ùå Erreur r√©cup√©ration historique envies');
      return false;
    }
  } else {
    console.error('‚ùå Erreur enregistrement envie:', await response.text());
    return false;
  }
}

async function testExerciseSessions(patientInfo, exerciseId) {
  console.log('\nüí™ Test: Sessions d\'exercices');

  if (!exerciseId) {
    console.log('‚ö†Ô∏è Pas d\'exercice disponible pour tester les sessions');
    return false;
  }

  // Enregistrer une session d'exercice
  const sessionData = {
    exerciseId: exerciseId,
    completedAt: new Date().toISOString(),
    notes: 'Session de test compl√©t√©e avec succ√®s'
  };

  console.log('1. Enregistrement d\'une session d\'exercice...');
  const { response } = await makeRequest(`${BASE_URL}/api/exercise-sessions`, {
    method: 'POST',
    body: JSON.stringify(sessionData)
  }, patientInfo.cookies);

  if (response.ok) {
    const result = await response.json();
    console.log('‚úÖ Session d\'exercice enregistr√©e:', result.id);
    
    // R√©cup√©rer l'historique des sessions
    console.log('2. R√©cup√©ration de l\'historique des sessions...');
    const { response: historyResponse } = await makeRequest(`${BASE_URL}/api/exercise-sessions`, {}, patientInfo.cookies);
    
    if (historyResponse.ok) {
      const history = await historyResponse.json();
      console.log(`‚úÖ Historique sessions r√©cup√©r√©: ${history.length} entr√©es`);
      return true;
    } else {
      console.error('‚ùå Erreur r√©cup√©ration historique sessions');
      return false;
    }
  } else {
    console.error('‚ùå Erreur enregistrement session:', await response.text());
    return false;
  }
}

async function testPsychoEducationContent(adminCookies) {
  console.log('\nüìñ Test: Contenu psycho√©ducatif');

  // 1. Lister le contenu existant
  console.log('1. R√©cup√©ration du contenu psycho√©ducatif...');
  const { response: contentResponse } = await makeRequest(`${BASE_URL}/api/psycho-education`);
  
  if (contentResponse.ok) {
    const content = await contentResponse.json();
    console.log(`‚úÖ ${content.length} contenus psycho√©ducatifs r√©cup√©r√©s`);
  } else {
    console.error('‚ùå Erreur r√©cup√©ration contenu psycho√©ducatif');
    return false;
  }

  // 2. Cr√©er un nouveau contenu (admin seulement)
  console.log('2. Cr√©ation d\'un nouveau contenu psycho√©ducatif (admin)...');
  const newContent = {
    title: `Article de test ${Date.now()}`,
    content: 'Contenu de test pour l\'article psycho√©ducatif',
    category: 'general',
    readingTime: 5
  };

  const { response: createResponse } = await makeRequest(`${BASE_URL}/api/psycho-education`, {
    method: 'POST',
    body: JSON.stringify(newContent)
  }, adminCookies);

  if (createResponse.ok) {
    const createdContent = await createResponse.json();
    console.log('‚úÖ Contenu psycho√©ducatif cr√©√©:', createdContent.id);
    return true;
  } else {
    console.error('‚ùå Erreur cr√©ation contenu psycho√©ducatif:', await createResponse.text());
    return false;
  }
}

async function testUserStats(patientInfo) {
  console.log('\nüìä Test: Statistiques utilisateur');

  const { response } = await makeRequest(`${BASE_URL}/api/users/${patientInfo.userId}/stats`, {}, patientInfo.cookies);

  if (response.ok) {
    const responseText = await response.text();
    if (!responseText) {
      console.log('‚ö†Ô∏è R√©ponse vide pour les statistiques');
      return false;
    }
    
    try {
      const stats = JSON.parse(responseText);
      console.log('‚úÖ Statistiques utilisateur r√©cup√©r√©es:', {
        totalSessions: stats.totalExerciseSessions || 0,
        totalCravings: stats.totalCravingEntries || 0,
        streakDays: stats.currentStreak || 0
      });
      return true;
    } catch (e) {
      console.error('‚ùå R√©ponse non-JSON pour les statistiques:', responseText.substring(0, 200));
      return false;
    }
  } else {
    console.error('‚ùå Erreur r√©cup√©ration statistiques:', await response.text());
    return false;
  }
}

async function runDataOperationsTest() {
  console.log('üöÄ D√©but des tests d\'enregistrement de donn√©es\n');

  // 1. Se connecter en tant qu'admin
  const adminCookies = await loginAsAdmin();
  if (!adminCookies) {
    console.log('‚ùå Tests administrateur impossibles sans connexion admin');
    return;
  }

  // 2. Se connecter en tant que patient
  const patientInfo = await loginAsPatient();
  if (!patientInfo) {
    console.log('‚ùå Tests patient impossibles sans connexion patient');
    return;
  }

  let results = {
    exercises: false,
    cravings: false,
    sessions: false,
    psychoEducation: false,
    userStats: false
  };

  // 3. Test des exercices
  const exerciseId = await testExerciseOperations(adminCookies, patientInfo);
  results.exercises = !!exerciseId;

  // 4. Test des envies
  results.cravings = await testCravingEntries(patientInfo);

  // 5. Test des sessions d'exercices
  results.sessions = await testExerciseSessions(patientInfo, exerciseId);

  // 6. Test du contenu psycho√©ducatif
  results.psychoEducation = await testPsychoEducationContent(adminCookies);

  // 7. Test des statistiques utilisateur
  results.userStats = await testUserStats(patientInfo);

  // R√©sum√©
  console.log('\nüìã R√©sum√© des tests:');
  console.log(`üìö Exercices: ${results.exercises ? '‚úÖ' : '‚ùå'}`);
  console.log(`üéØ Envies: ${results.cravings ? '‚úÖ' : '‚ùå'}`);
  console.log(`üí™ Sessions: ${results.sessions ? '‚úÖ' : '‚ùå'}`);
  console.log(`üìñ Contenu psycho√©ducatif: ${results.psychoEducation ? '‚úÖ' : '‚ùå'}`);
  console.log(`üìä Statistiques: ${results.userStats ? '‚úÖ' : '‚ùå'}`);

  const successCount = Object.values(results).filter(Boolean).length;
  const totalTests = Object.keys(results).length;
  
  console.log(`\nüèÅ Tests termin√©s: ${successCount}/${totalTests} r√©ussis`);
  
  if (successCount === totalTests) {
    console.log('üéâ Tous les tests d\'enregistrement de donn√©es ont r√©ussi !');
  } else {
    console.log('‚ö†Ô∏è Certains tests ont √©chou√©, v√©rifiez les logs ci-dessus');
  }
}

// Ex√©cuter les tests
runDataOperationsTest().catch(error => {
  console.error('üí• Erreur critique:', error);
  process.exit(1);
});