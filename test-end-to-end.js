#!/usr/bin/env node

import axios from 'axios';

const BASE_URL = 'https://5000-in3polffn04iyw7zr43g5-6532622b.e2b.dev';
const API_URL = `${BASE_URL}/api`;

const client = axios.create({
  baseURL: API_URL,
  withCredentials: true,
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json'
  }
});

let sessionCookies = '';

const extractCookies = (response) => {
  const cookies = response.headers['set-cookie'];
  if (cookies) {
    sessionCookies = cookies.map(cookie => cookie.split(';')[0]).join('; ');
    client.defaults.headers.Cookie = sessionCookies;
  }
};

console.log('üé≠ === TESTS END-TO-END - PARCOURS UTILISATEUR COMPLET ===\n');

const testResults = {
  healthCheck: false,
  patientRegistration: false,
  patientLogin: false,
  applicationAccess: false,
  exerciseAccess: false,
  exerciseSession: false,
  cravingTracking: false,
  beckAnalysis: false,
  strategySaving: false,
  statisticsAccess: false,
  adminLogin: false,
  adminDashboard: false,
  contentManagement: false,
  userManagement: false
};

// 1. Health Check
console.log('1Ô∏è‚É£ V√©rification de la sant√© de l\'application...');
try {
  const response = await client.get('/health');
  console.log('‚úÖ Application en ligne et fonctionnelle');
  console.log(`   Status: ${response.data.status}`);
  console.log(`   Environment: ${response.data.env}`);
  testResults.healthCheck = true;
} catch (error) {
  console.error('‚ùå Application non accessible:', error.message);
  process.exit(1);
}

// 2. Patient Registration Journey
console.log('\n2Ô∏è‚É£ Parcours d\'inscription patient...');
const patientEmail = `patient.e2e.${Date.now()}@example.com`;
const patientData = {
  email: patientEmail,
  password: 'test123',
  firstName: 'Alice',
  lastName: 'Testeur',
  role: 'patient'
};

try {
  const response = await client.post('/auth/register', patientData);
  extractCookies(response);
  console.log('‚úÖ Inscription patient r√©ussie');
  console.log(`   Email: ${response.data.user.email}`);
  console.log(`   Nom: ${response.data.user.firstName} ${response.data.user.lastName}`);
  testResults.patientRegistration = true;
} catch (error) {
  console.error('‚ùå Inscription patient √©chou√©e:', error.response?.data?.message || error.message);
}

// 3. Patient Login Test  
console.log('\n3Ô∏è‚É£ Test de connexion patient...');
sessionCookies = '';
client.defaults.headers.Cookie = '';

try {
  const response = await client.post('/auth/login', {
    email: patientEmail,
    password: 'test123'
  });
  extractCookies(response);
  console.log('‚úÖ Connexion patient r√©ussie');
  console.log(`   Session √©tablie pour: ${response.data.user.email}`);
  testResults.patientLogin = true;
} catch (error) {
  console.error('‚ùå Connexion patient √©chou√©e:', error.response?.data?.message || error.message);
}

// 4. Application Access Test
console.log('\n4Ô∏è‚É£ Test d\'acc√®s √† l\'application web...');
try {
  const response = await axios.get(BASE_URL, {
    timeout: 5000,
    headers: { 'User-Agent': 'E2E-Test-Client' }
  });
  
  if (response.status === 200 && response.data.includes('<!DOCTYPE html>')) {
    console.log('‚úÖ Interface web accessible');
    console.log(`   Taille de la page: ${response.data.length} bytes`);
    
    // Check for React app indicators
    if (response.data.includes('root') || response.data.includes('react')) {
      console.log('   ‚úÖ Application React d√©tect√©e');
    }
    testResults.applicationAccess = true;
  }
} catch (error) {
  console.error('‚ùå Acc√®s √† l\'interface web √©chou√©:', error.message);
}

// 5. Exercise Access and Session
console.log('\n5Ô∏è‚É£ Test d\'acc√®s aux exercices et cr√©ation de session...');
let exerciseId = null;

try {
  const exercisesResponse = await client.get('/exercises');
  console.log(`‚úÖ ${exercisesResponse.data.length} exercices disponibles`);
  testResults.exerciseAccess = true;
  
  if (exercisesResponse.data.length > 0) {
    exerciseId = exercisesResponse.data[0].id;
    console.log(`   Premier exercice: ${exercisesResponse.data[0].title}`);
    
    // Create exercise session
    const sessionData = {
      exerciseId: exerciseId,
      duration: 480, // 8 minutes
      cravingBefore: 8,
      cravingAfter: 2,
      notes: 'Session E2E test - tr√®s efficace',
      completed: true
    };
    
    const sessionResponse = await client.post('/exercise-sessions', sessionData);
    console.log('‚úÖ Session d\'exercice enregistr√©e');
    console.log(`   R√©duction craving: ${sessionData.cravingBefore} ‚Üí ${sessionData.cravingAfter} (-${sessionData.cravingBefore - sessionData.cravingAfter} pts)`);
    testResults.exerciseSession = true;
  }
} catch (error) {
  console.error('‚ùå Test exercices √©chou√©:', error.response?.data?.message || error.message);
}

// 6. Craving Tracking
console.log('\n6Ô∏è‚É£ Test de suivi des cravings...');
const cravingEntries = [
  { intensity: 7, trigger: 'stress', context: 'r√©union importante', notes: 'Tension √©lev√©e' },
  { intensity: 4, trigger: 'ennui', context: 'pause d√©jeuner', notes: 'Besoin de distraction' },
  { intensity: 9, trigger: '√©motion', context: 'dispute familiale', notes: 'Tr√®s fort besoin de r√©confort' }
];

let cravingCount = 0;
for (const cravingData of cravingEntries) {
  try {
    const response = await client.post('/cravings', cravingData);
    cravingCount++;
    console.log(`   ‚úÖ Craving ${cravingCount} enregistr√© (intensit√©: ${cravingData.intensity}/10)`);
  } catch (error) {
    console.error(`   ‚ùå Craving ${cravingCount + 1} √©chou√©:`, error.response?.data?.message);
  }
}

if (cravingCount > 0) {
  console.log(`‚úÖ ${cravingCount}/${cravingEntries.length} cravings enregistr√©s avec succ√®s`);
  testResults.cravingTracking = true;
  
  // Test craving stats
  try {
    const statsResponse = await client.get('/cravings/stats');
    console.log(`   üìä Intensit√© moyenne: ${statsResponse.data.average}/10`);
  } catch (error) {
    console.log('   ‚ö†Ô∏è  Statistiques cravings non disponibles');
  }
}

// 7. Beck Analysis
console.log('\n7Ô∏è‚É£ Test d\'analyse cognitive Beck...');
const beckData = {
  situation: 'Craving intense en voyant une publicit√©',
  automaticThought: 'Je vais craquer, je n\'ai aucune volont√©',
  emotion: 'frustration',
  emotionIntensity: 8,
  physicalSensations: 'n≈ìud √† l\'estomac, tension',
  behavior: '√©viter la publicit√©, faire de la respiration',
  alternativeThought: 'C\'est normal d\'avoir des envies, √ßa va passer',
  outcome: 'sensation de contr√¥le, craving diminu√©'
};

try {
  const response = await client.post('/beck-analyses', beckData);
  console.log('‚úÖ Analyse Beck enregistr√©e avec succ√®s');
  console.log(`   Situation: ${beckData.situation}`);
  console.log(`   √âmotion: ${beckData.emotion} (${beckData.emotionIntensity}/10)`);
  testResults.beckAnalysis = true;
} catch (error) {
  console.error('‚ùå Analyse Beck √©chou√©e:', error.response?.data?.message || error.message);
}

// 8. Anti-Craving Strategies
console.log('\n8Ô∏è‚É£ Test de sauvegarde des strat√©gies anti-craving...');
const strategiesData = {
  strategies: [
    {
      context: 'Test E2E - Bureau stressant',
      exercise: 'Respiration 4-7-8 avec visualisation',
      effort: 6,
      duration: 420, // 7 minutes
      cravingBefore: 8,
      cravingAfter: 2
    }
  ]
};

try {
  const response = await client.post('/strategies', strategiesData);
  console.log('‚úÖ Strat√©gie anti-craving sauvegard√©e');
  console.log(`   Efficacit√©: ${strategiesData.strategies[0].cravingBefore} ‚Üí ${strategiesData.strategies[0].cravingAfter}`);
  testResults.strategySaving = true;
} catch (error) {
  console.error('‚ùå Sauvegarde strat√©gie √©chou√©e:', error.response?.data?.message || error.message);
}

// 9. User Statistics
console.log('\n9Ô∏è‚É£ Test d\'acc√®s aux statistiques utilisateur...');
try {
  const statsResponse = await client.get('/users/stats');
  console.log('‚úÖ Statistiques utilisateur r√©cup√©r√©es');
  console.log(`   Exercices compl√©t√©s: ${statsResponse.data.exercisesCompleted || 0}`);
  console.log(`   Dur√©e totale: ${Math.round((statsResponse.data.totalDuration || 0) / 60)} minutes`);
  console.log(`   Analyses Beck: ${statsResponse.data.beckAnalysesCompleted || 0}`);
  testResults.statisticsAccess = true;
} catch (error) {
  console.error('‚ùå Statistiques utilisateur √©chou√©es:', error.response?.data?.message || error.message);
}

// 10. Admin Login Test
console.log('\nüîü Test de connexion administrateur...');
sessionCookies = '';
client.defaults.headers.Cookie = '';

try {
  const response = await client.post('/auth/login', {
    email: 'admin@apaddicto.com',
    password: 'admin123'
  });
  extractCookies(response);
  console.log('‚úÖ Connexion admin r√©ussie');
  console.log(`   Admin: ${response.data.user.firstName} ${response.data.user.lastName}`);
  testResults.adminLogin = true;
} catch (error) {
  console.error('‚ùå Connexion admin √©chou√©e:', error.response?.data?.message || error.message);
}

// 11. Admin Dashboard
console.log('\n1Ô∏è‚É£1Ô∏è‚É£ Test du tableau de bord administrateur...');
try {
  const usersResponse = await client.get('/admin/users');
  const exercisesResponse = await client.get('/admin/exercises');
  
  console.log('‚úÖ Tableau de bord admin accessible');
  console.log(`   üë• Utilisateurs g√©r√©s: ${usersResponse.data.length}`);
  console.log(`   üèãÔ∏è Exercices disponibles: ${exercisesResponse.data.length}`);
  
  const patients = usersResponse.data.filter(u => u.role === 'patient');
  console.log(`   üë§ Patients actifs: ${patients.length}`);
  testResults.adminDashboard = true;
} catch (error) {
  console.error('‚ùå Tableau de bord admin √©chou√©:', error.response?.data?.message || error.message);
}

// 12. Content Management Test
console.log('\n1Ô∏è‚É£2Ô∏è‚É£ Test de gestion de contenu admin...');
try {
  const contentResponse = await client.get('/admin/psycho-education');
  console.log(`‚úÖ Gestion de contenu accessible (${contentResponse.data.length} contenus)`);
  testResults.contentManagement = true;
} catch (error) {
  console.error('‚ùå Gestion de contenu √©chou√©e:', error.response?.data?.message || error.message);
}

// 13. User Management Test
console.log('\n1Ô∏è‚É£3Ô∏è‚É£ Test de gestion des utilisateurs...');
try {
  const dataResponse = await client.get('/data');
  if (dataResponse.data.users) {
    console.log(`‚úÖ Gestion utilisateurs accessible (${dataResponse.data.users.length} utilisateurs total)`);
    
    const recentUsers = dataResponse.data.users.filter(u => {
      const userDate = new Date(u.created_at);
      const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000);
      return userDate > yesterday;
    });
    
    console.log(`   üìà Nouveaux utilisateurs (24h): ${recentUsers.length}`);
    testResults.userManagement = true;
  }
} catch (error) {
  console.error('‚ùå Gestion utilisateurs √©chou√©e:', error.response?.data?.message || error.message);
}

// Final Results Summary
console.log('\nüìä === R√âSULTATS COMPLETS DES TESTS E2E ===');

const successCount = Object.values(testResults).filter(result => result === true).length;
const totalTests = Object.keys(testResults).length;
const successRate = (successCount / totalTests * 100).toFixed(1);

console.log(`\nüéØ Taux de r√©ussite global: ${successCount}/${totalTests} (${successRate}%)`);

console.log('\nüìã D√©tail des tests:');
Object.entries(testResults).forEach(([test, result]) => {
  const icon = result ? '‚úÖ' : '‚ùå';
  const testName = test.replace(/([A-Z])/g, ' $1').toLowerCase();
  console.log(`   ${icon} ${testName}`);
});

if (successRate >= 90) {
  console.log('\nüåü === APPLICATION ENTI√àREMENT FONCTIONNELLE ===');
  console.log('üéä F√©licitations ! L\'application passe tous les tests critiques');
  console.log('‚ú® Pr√™te pour la production et les utilisateurs finaux');
} else if (successRate >= 75) {
  console.log('\n‚ö†Ô∏è === APPLICATION MAJORITAIREMENT FONCTIONNELLE ===');
  console.log('üîß Quelques fonctionnalit√©s n√©cessitent des ajustements');
  console.log('üìù Voir les √©checs ci-dessus pour les corrections n√©cessaires');
} else {
  console.log('\n‚ùå === PROBL√àMES CRITIQUES D√âTECT√âS ===');
  console.log('üö® L\'application n√©cessite des corrections importantes');
  console.log('‚ö° V√©rifier la configuration et les d√©pendances');
}

console.log('\nüîó URL de l\'application: ' + BASE_URL);
console.log('üìß Compte de test patient: ' + patientEmail + ' / test123');
console.log('üë®‚Äç‚öïÔ∏è Compte admin: admin@apaddicto.com / admin123');
console.log('\nüé≠ Tests E2E termin√©s !');